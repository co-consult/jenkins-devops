pipeline {
    agent any

    environment {
        DOCKER_REGISTRY = 'ousshen'
        DOCKER_REPO = 'cogeex'
        DOCKER_CRED_ID = 'docker_creds'
        SSH_CRED_ID = 'ssh-credentials'
        AZURE_GIT_CRED_ID = 'azure_secret'
        GIT_CRED_ID = 'git_secret'
        JENKINS_DEVOPS_REPO = 'https://github.com/co-consult/jenkins-devops'
        JENKINS_DEVOPS_BRANCH = 'DEVOPS-13'
        VPS_USER = 'ubuntu'
        VPS_HOST = '20.19.38.22'
    }

    stages {
        stage('Push Microservice Images') {
            parallel {
                stage('Push Eureka') {
                    steps {
                        script {
                            def imageTag = "${DOCKER_REGISTRY}/${DOCKER_REPO}:eureka-latest-${BUILD_NUMBER}"
                            def customImage = docker.image('cogeex/eureka-latest')
                            docker.withRegistry('', "${DOCKER_CRED_ID}") {
                                customImage.push(imageTag)
                            }
                        }
                    }
                }
                stage('Push Gateway') {
                    steps {
                        script {
                            def imageTag = "${DOCKER_REGISTRY}/${DOCKER_REPO}:gateway-latest-${BUILD_NUMBER}"
                            def customImage = docker.image('cogeex/gateway-latest')
                            docker.withRegistry('', "${DOCKER_CRED_ID}") {
                                customImage.push(imageTag)
                            }
                        }
                    }
                }
                stage('Push Auth Service') {
                    steps {
                        script {
                            def imageTag = "${DOCKER_REGISTRY}/${DOCKER_REPO}:auth-service-latest-${BUILD_NUMBER}"
                            def customImage = docker.image('cogeex/auth-service-latest')
                            docker.withRegistry('', "${DOCKER_CRED_ID}") {
                                customImage.push(imageTag)
                            }
                        }
                    }
                }
                stage('Push Company Service') {
                    steps {
                        script {
                            def imageTag = "${DOCKER_REGISTRY}/${DOCKER_REPO}:company-service-latest-${BUILD_NUMBER}"
                            def customImage = docker.image('cogeex/company-service-latest')
                            docker.withRegistry('', "${DOCKER_CRED_ID}") {
                                customImage.push(imageTag)
                            }
                        }
                    }
                }
                stage('Push Profile Service') {
                    steps {
                        script {
                            def imageTag = "${DOCKER_REGISTRY}/${DOCKER_REPO}:profile-service-latest-${BUILD_NUMBER}"
                            def customImage = docker.image('cogeex/profile-service-latest')
                            docker.withRegistry('', "${DOCKER_CRED_ID}") {
                                customImage.push(imageTag)
                            }
                        }
                    }
                }
                stage('Push Project Service') {
                    steps {
                        script {
                            def imageTag = "${DOCKER_REGISTRY}/${DOCKER_REPO}:project-service-latest-${BUILD_NUMBER}"
                            def customImage = docker.image('cogeex/project-service-latest')
                            docker.withRegistry('', "${DOCKER_CRED_ID}") {
                                customImage.push(imageTag)
                            }
                        }
                    }
                }
                stage('Push Parser Service') {
                    steps {
                        script {
                            def imageTag = "${DOCKER_REGISTRY}/${DOCKER_REPO}:parser-service-latest-${BUILD_NUMBER}"
                            def customImage = docker.image('cogeex/parser-service-latest')
                            docker.withRegistry('', "${DOCKER_CRED_ID}") {
                                customImage.push(imageTag)
                            }
                        }
                    }
                }
                stage('Push Python Service') {
                    steps {
                        script {
                            echo "Warning: Python service image not found locally. Skipping push."
                            def imageTag = "${DOCKER_REGISTRY}/${DOCKER_REPO}:matching-service-latest-${BUILD_NUMBER}"
                            def customImage = docker.image('cogeex/python-service-latest')
                            docker.withRegistry('', "${DOCKER_CRED_ID}") {
                                customImage.push(imageTag)
                            }
                        }
                    }
                }
            }
        }

        stage('Build and Push Frontend') {
            steps {
                checkout([$class: 'GitSCM',
                    branches: [[name: '*/develop']],
                    extensions: [],
                    userRemoteConfigs: [[
                        credentialsId: "${AZURE_GIT_CRED_ID}",
                        url: 'https://dev.azure.com/CoConsult/CoGeex%20v2/_git/Cogeex-FrontEnd'
                    ]]
                ])
                script {
                    def dockerfile = 'Dockerfile.preprod'
                    def imageTag = "${DOCKER_REGISTRY}/${DOCKER_REPO}:frontend-latest-${BUILD_NUMBER}"
                    def customImage = docker.build(imageTag, "-f ${dockerfile} .")
                    docker.withRegistry('', "${DOCKER_CRED_ID}") {
                        customImage.push()
                    }
                }
            }
        }

        stage('Deploy to VPS') {
            steps {
                checkout([$class: 'GitSCM',
                    branches: [[name: "*/${JENKINS_DEVOPS_BRANCH}"]],
                    extensions: [],
                    userRemoteConfigs: [[
                        credentialsId: "${GIT_CRED_ID}",
                        url: "${JENKINS_DEVOPS_REPO}"
                    ]]
                ])
                sshagent(credentials: ["${SSH_CRED_ID}"]) {
                    sh """
                    mkdir -p manifests
                    cp jenkins-devops/*.yaml manifests/
                    scp -o StrictHostKeyChecking=no manifests/*.yaml ${VPS_USER}@${VPS_HOST}:/home/${VPS_USER}/manifests/
                    ssh -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'EOF'
                        mkdir -p /home/${VPS_USER}/manifests
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-db.yaml || echo "Warning: cogeex-db.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-eureka.yaml || echo "Warning: cogeex-eureka.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-gateway.yaml || echo "Warning: cogeex-gateway.yaml failed"
                        kubectl wait --for=condition=ready pod -l app=cogeex-eureka --timeout=120s || echo "Warning: Eureka pods not ready"
                        kubectl wait --for=condition=ready pod -l app=cogeex-gateway --timeout=120s || echo "Warning: Gateway pods not ready"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-auth-service.yaml || echo "Warning: cogeex-auth-service.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-company-service.yaml || echo "Warning: cogeex-company-service.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-profile-service.yaml || echo "Warning: cogeex-profile-service.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-project-service.yaml || echo "Warning: cogeex-project-service.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-parser-service.yaml || echo "Warning: cogeex-parser-service.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-python-service.yaml || echo "Warning: cogeex-python-service.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-frontend-deployment.yaml || echo "Warning: cogeex-frontend-deployment.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-gateway-service.yaml || echo "Warning: cogeex-gateway-service.yaml failed"
                        kubectl apply -f /home/${VPS_USER}/manifests/cogeex-frontend-service.yaml || echo "Warning: cogeex-frontend-service.yaml failed"
                        kubectl get pods -A
                        kubectl get svc
                    EOF
                    """
                }
            }
        }
    }

    post {
        success {
            echo "Deployment done!"
        }
        failure {
            echo "Deployment failed. Check logs."
        }
    }
}